# BLE Token Length Validation Fix

## Problem
The `add_attendance_secure` RPC function was returning an error:
```json
{
  "error": "invalid_token_security",
  "details": "invalid_length",
  "message": "Token must be exactly 12 characters"
}
```

## Root Cause
The session tokens stored in the `events` table's `description` JSONB field were either:
1. NULL or empty
2. Not exactly 12 characters long
3. Incorrectly formatted

When `get_active_sessions` retrieved these tokens from the database, it returned sessions with invalid tokens. These were then passed to `addAttendance`, which failed validation.

## Solution Implemented

### 1. Added Token Validation in `getActiveSessions` (BLESessionService.ts)
- **Filter invalid tokens** before returning sessions to the UI
- **Log each session** during retrieval to identify problematic tokens
- **Validate token format** using `isValidSessionToken()` (12 alphanumeric characters)
- **Filter out sessions** with NULL, empty, or invalid-length tokens

This prevents invalid tokens from ever reaching the check-in flow.

### 2. Added Comprehensive Logging
Added detailed logging at every step to track token values:

- **In `getActiveSessions`**: Log all sessions retrieved from database with token details
- **In `handleManualCheckIn`**: Log token before submitting to `addAttendance`
- **In `addAttendance`**: Log token before and after sanitization and validation

### 3. Added Error Handling
Added specific error handling for `invalid_token_security` errors in `handleManualCheckIn` to show clear error messages to users.

## What to Check in the Database

### Check for Invalid Tokens
Run this query to find sessions with invalid tokens:

```sql
SELECT 
    e.id,
    e.title,
    e.description::JSONB->>'session_token' as session_token,
    LENGTH(e.description::JSONB->>'session_token') as token_length,
    e.starts_at,
    e.ends_at,
    e.description::JSONB->>'attendance_method' as method
FROM events e
WHERE e.description::JSONB->>'attendance_method' = 'ble'
AND e.ends_at > NOW()
AND (
    e.description::JSONB->>'session_token' IS NULL
    OR LENGTH(e.description::JSONB->>'session_token') != 12
    OR e.description::JSONB->>'session_token' !~ '^[A-Za-z0-9]{12}$'
);
```

### Fix Invalid Tokens
If you find sessions with invalid tokens, you can either:

1. **Delete them** (if they're not needed):
```sql
DELETE FROM events 
WHERE id = '<event_id>';
```

2. **Update them** with a new valid token (generated by `create_session_secure`):
```sql
-- First, generate a new valid token using the create_session_secure function
SELECT create_session_secure(
    '<org_id>'::UUID,
    'Session Title',
    NOW(),
    3600
);

-- Then copy the returned session_token and update the event
UPDATE events
SET description = jsonb_set(
    description,
    '{session_token}',
    '"<new_12_char_token>"'::jsonb
)
WHERE id = '<event_id>';
```

## How Session Creation Works

When an officer creates a BLE session, the system:
1. Calls `create_session_secure` in the database
2. Generates a cryptographically secure 12-character token
3. Stores it in the `events.description` JSONB field as `session_token`
4. The token uses only uppercase alphanumeric characters (no ambiguous chars like O, 0, I, 1)

## Expected Token Format
- **Length**: Exactly 12 characters
- **Character set**: `ABCDEFGHJKLMNPQRSTUVWXYZ23456789` (no ambiguous characters)
- **Example**: `ABC23456XYZQ`

## Testing the Fix

### 1. Check Console Logs
When a member opens the BLE Attendance screen, check the console for:
```
[BLESessionService] üìã Received X sessions from database
[BLESessionService] üîç Validating session: { title: "...", token: "...", tokenLength: 12 }
[BLESessionService] ‚úÖ Returning X valid sessions (filtered from Y total)
```

### 2. If Sessions Are Filtered Out
If you see warnings like:
```
‚ö†Ô∏è Session "Title" has invalid token format: "..." (length: X)
```

Then you need to check the database and fix those sessions.

### 3. Test Manual Check-In
1. Create a new BLE session using `create_session_secure`
2. Verify the token is exactly 12 characters
3. Try manual check-in
4. Check logs for the full token flow:
   ```
   [handleManualCheckIn] üéØ Starting manual check-in
   [BLESessionService.addAttendance] üé´ Starting attendance recording
   [BLESessionService.addAttendance] üßπ After sanitization
   [BLESessionService.addAttendance] üîí Validating token security
   [BLESessionService.addAttendance] ‚úÖ Token validation passed
   ```

## Files Modified
- `/src/services/BLESessionService.ts` - Added token validation and filtering in `getActiveSessions` and enhanced logging in `addAttendance`
- `/src/screens/member/MemberBLEAttendanceScreen.tsx` - Added comprehensive logging in `handleManualCheckIn`

## Next Steps
1. **Run the database query** to check for invalid tokens
2. **Fix or delete** any sessions with invalid tokens
3. **Test** by creating a new session and attempting check-in
4. **Monitor logs** to ensure tokens are valid throughout the flow
5. **If issue persists**, check if `create_session_secure` is generating valid tokens
